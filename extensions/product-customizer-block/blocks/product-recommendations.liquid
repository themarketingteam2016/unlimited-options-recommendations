{% comment %}
  Product Recommendations Widget
  Displays recommended products for the current product
{% endcomment %}

<div id="unlimited-recommendations-{{ block.id }}" class="unlimited-recommendations" {{ block.shopify_attributes }}>
  <div id="recommendations-root"></div>
</div>

<script>
  (function() {
    const productId = 'gid://shopify/Product/{{ product.id }}';
    const apiUrl = 'https://unlimtited-options-recommendations.vercel.app';
    const blockId = '{{ block.id }}';

    const container = document.getElementById('unlimited-recommendations-' + blockId);
    const root = container.querySelector('#recommendations-root');

    // Show loading state
    root.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">Loading recommendations...</div>';

    async function loadRecommendations() {
      try {
        console.log('Loading recommendations for product:', productId);

        // Fetch recommendations
        const response = await fetch(`${apiUrl}/api/products/${encodeURIComponent(productId)}/recommendations`);
        const recommendations = await response.json();

        console.log('Fetched recommendations:', recommendations);

        if (!recommendations || recommendations.length === 0) {
          root.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">No recommendations available.</div>';
          return;
        }

        renderRecommendations(recommendations);

      } catch (error) {
        console.error('Error loading recommendations:', error);
        root.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">Unable to load recommendations.</div>';
      }
    }

    function renderRecommendations(recommendations) {
      const html = `
        <div class="unlimited-recommendations-widget">
          <h3 class="unlimited-recommendations-title">You May Also Like</h3>
          <div class="unlimited-recommendations-grid">
            ${recommendations.map(rec => {
              const product = rec.recommended_product;
              if (!product) return '';

              const imageUrl = product.featuredImage?.url || product.image_url || '';
              const productUrl = `/products/${product.handle || ''}`;
              const price = product.variants?.[0]?.price || product.price || '0.00';

              return `
                <div class="unlimited-recommendation-card">
                  <a href="${productUrl}" class="unlimited-recommendation-link">
                    ${imageUrl ? `
                      <div class="unlimited-recommendation-image">
                        <img src="${imageUrl}" alt="${product.title}" loading="lazy">
                      </div>
                    ` : ''}
                    <div class="unlimited-recommendation-details">
                      <h4 class="unlimited-recommendation-product-title">${product.title}</h4>
                      ${rec.reason ? `
                        <p class="unlimited-recommendation-reason">${rec.reason}</p>
                      ` : ''}
                      <div class="unlimited-recommendation-price">$${price}</div>
                    </div>
                  </a>
                  <button
                    class="unlimited-recommendation-view-btn"
                    onclick="window.location.href='${productUrl}'"
                  >
                    View Product
                  </button>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      root.innerHTML = html;
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadRecommendations);
    } else {
      loadRecommendations();
    }
  })();
</script>

<style>
  .unlimited-recommendations {
    margin: 40px 0;
    padding: 0;
  }

  .unlimited-recommendations-widget {
    max-width: 100%;
  }

  .unlimited-recommendations-title {
    font-size: 24px;
    font-weight: 700;
    color: #202223;
    margin-bottom: 24px;
    text-align: center;
  }

  .unlimited-recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 20px;
  }

  @media (max-width: 768px) {
    .unlimited-recommendations-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }
  }

  .unlimited-recommendation-card {
    background: white;
    border: 1px solid #e3e5e7;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .unlimited-recommendation-card:hover {
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
    transform: translateY(-4px);
    border-color: #008060;
  }

  .unlimited-recommendation-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .unlimited-recommendation-image {
    width: 100%;
    height: 250px;
    overflow: hidden;
    background: #f6f6f7;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .unlimited-recommendation-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .unlimited-recommendation-card:hover .unlimited-recommendation-image img {
    transform: scale(1.05);
  }

  .unlimited-recommendation-details {
    padding: 16px;
  }

  .unlimited-recommendation-product-title {
    font-size: 16px;
    font-weight: 600;
    color: #202223;
    margin: 0 0 8px 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .unlimited-recommendation-reason {
    font-size: 13px;
    color: #6d7175;
    margin: 0 0 12px 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .unlimited-recommendation-price {
    font-size: 20px;
    font-weight: 700;
    color: #008060;
    margin-bottom: 0;
  }

  .unlimited-recommendation-view-btn {
    width: 100%;
    padding: 12px 20px;
    border: none;
    background: #008060;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .unlimited-recommendation-view-btn:hover {
    background: #006e52;
  }

  .unlimited-recommendation-view-btn:active {
    transform: scale(0.98);
  }
</style>

{% schema %}
{
  "name": "Product Recommendations",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You May Also Like"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 6,
      "step": 1,
      "label": "Number of products to show",
      "default": 2
    },
    {
      "type": "checkbox",
      "id": "show_reason",
      "label": "Show recommendation reason",
      "default": true
    }
  ]
}
{% endschema %}
