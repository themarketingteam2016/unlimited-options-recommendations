<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <title>Unlimited Options App</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f6f6f7;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    h1 { font-size: 28px; margin-bottom: 10px; color: #202223; }
    h2 { font-size: 20px; margin: 25px 0 15px; color: #202223; }
    h3 { font-size: 16px; margin: 15px 0 10px; color: #202223; }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #008060;
      color: white;
    }

    .btn-primary:hover { background: #006e52; }

    .btn-secondary {
      background: #f1f2f4;
      color: #202223;
    }

    .btn-secondary:hover { background: #e3e5e7; }

    .btn-danger {
      background: #d72c0d;
      color: white;
    }

    .btn-danger:hover { background: #bf2600; }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .product-card {
      border: 1px solid #e3e5e7;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .product-card:hover {
      border-color: #008060;
      box-shadow: 0 4px 12px rgba(0, 128, 96, 0.1);
    }

    .product-card.selected {
      border-color: #008060;
      background: #f4f6f8;
    }

    .product-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 10px;
      background: #f6f6f7;
    }

    .input-group {
      margin: 15px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #202223;
      font-size: 14px;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #c9cccf;
      border-radius: 6px;
      font-size: 14px;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #008060;
    }

    .option-item {
      background: #f6f6f7;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }

    .option-values {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .value-tag {
      background: white;
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid #c9cccf;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .value-tag button {
      background: none;
      border: none;
      color: #bf0711;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
    }

    .variant-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .variant-table th,
    .variant-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e3e5e7;
    }

    .variant-table th {
      background: #f6f6f7;
      font-weight: 600;
      color: #202223;
    }

    .variant-table input {
      padding: 8px;
      border: 1px solid #c9cccf;
      border-radius: 4px;
      width: 100%;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6d7175;
    }

    .success-message {
      background: #d1f0e5;
      color: #004c3f;
      padding: 12px 20px;
      border-radius: 6px;
      margin: 15px 0;
    }

    .error-message {
      background: #fed3d1;
      color: #6a1b1b;
      padding: 12px 20px;
      border-radius: 6px;
      margin: 15px 0;
    }

    .tabs {
      display: flex;
      gap: 10px;
      border-bottom: 2px solid #e3e5e7;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #6d7175;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab.active {
      color: #008060;
      border-bottom-color: #008060;
    }

    .flex {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [products, setProducts] = useState([]);
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [options, setOptions] = useState([]);
      const [combinations, setCombinations] = useState([]);
      const [variants, setVariants] = useState([]);
      const [loading, setLoading] = useState(true);
      const [message, setMessage] = useState(null);
      const [activeTab, setActiveTab] = useState('products');
      const [newOption, setNewOption] = useState({ name: '', value: '' });

      useEffect(() => {
        fetchProducts();
      }, []);

      const fetchProducts = async () => {
        try {
          const res = await fetch('/api/products');
          const data = await res.json();
          setProducts(data);
          setLoading(false);
        } catch (error) {
          console.error('Error fetching products:', error);
          setLoading(false);
        }
      };

      const selectProduct = async (product) => {
        setSelectedProduct(product);
        setActiveTab('options');

        // Load existing options
        try {
          const res = await fetch(`/api/options/${product.id.split('/').pop()}`);
          const data = await res.json();
          if (data.length > 0) {
            setOptions(data);
          }
        } catch (error) {
          console.error('Error loading options:', error);
        }
      };

      const addOption = () => {
        if (!newOption.name) return;
        const existing = options.find(o => o.option_name === newOption.name);
        if (existing) {
          setMessage({ type: 'error', text: 'Option already exists!' });
          return;
        }
        setOptions([...options, { option_name: newOption.name, values: [] }]);
        setNewOption({ name: '', value: '' });
      };

      const addValueToOption = (optionName) => {
        if (!newOption.value) return;
        setOptions(options.map(opt => {
          if (opt.option_name === optionName) {
            if (opt.values.includes(newOption.value)) {
              setMessage({ type: 'error', text: 'Value already exists!' });
              return opt;
            }
            return { ...opt, values: [...opt.values, newOption.value] };
          }
          return opt;
        }));
        setNewOption({ ...newOption, value: '' });
      };

      const removeValue = (optionName, value) => {
        setOptions(options.map(opt => {
          if (opt.option_name === optionName) {
            return { ...opt, values: opt.values.filter(v => v !== value) };
          }
          return opt;
        }));
      };

      const removeOption = (optionName) => {
        setOptions(options.filter(o => o.option_name !== optionName));
      };

      const saveOptions = async () => {
        try {
          const productId = selectedProduct.id.split('/').pop();
          const formattedOptions = options.map(o => ({
            name: o.option_name,
            values: o.values
          }));

          await fetch('/api/options/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId, options: formattedOptions })
          });

          setMessage({ type: 'success', text: 'Options saved successfully!' });
          setTimeout(() => setMessage(null), 3000);
        } catch (error) {
          setMessage({ type: 'error', text: 'Failed to save options!' });
        }
      };

      const generateCombinations = async () => {
        try {
          const formattedOptions = options.map(o => ({
            name: o.option_name,
            values: o.values
          }));

          const res = await fetch('/api/options/generate-combinations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ options: formattedOptions })
          });

          const data = await res.json();
          const variantsWithDefaults = data.map(combo => ({
            options: combo,
            price: '',
            sku: '',
            inventory_qty: 0,
            is_active: true
          }));

          setCombinations(variantsWithDefaults);
          setActiveTab('variants');
          setMessage({ type: 'success', text: `Generated ${data.length} combinations!` });
          setTimeout(() => setMessage(null), 3000);
        } catch (error) {
          setMessage({ type: 'error', text: 'Failed to generate combinations!' });
        }
      };

      const updateVariantField = (index, field, value) => {
        setCombinations(combinations.map((v, i) => {
          if (i === index) {
            return { ...v, [field]: value };
          }
          return v;
        }));
      };

      const saveVariants = async () => {
        try {
          const productId = selectedProduct.id.split('/').pop();
          await fetch('/api/variants/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId, variants: combinations })
          });

          setMessage({ type: 'success', text: 'Variants saved successfully!' });
          setTimeout(() => setMessage(null), 3000);
        } catch (error) {
          setMessage({ type: 'error', text: 'Failed to save variants!' });
        }
      };

      if (loading) {
        return <div className="loading">Loading products...</div>;
      }

      return (
        <div className="container">
          <h1>Unlimited Product Options</h1>
          <p style={{color: '#6d7175', marginBottom: '20px'}}>Create unlimited variants beyond Shopify's 100 variant limit</p>

          {message && (
            <div className={message.type === 'success' ? 'success-message' : 'error-message'}>
              {message.text}
            </div>
          )}

          {!selectedProduct ? (
            <>
              <h2>Select a Product</h2>
              <div className="product-grid">
                {products.map(product => (
                  <div
                    key={product.id}
                    className="product-card"
                    onClick={() => selectProduct(product)}
                  >
                    {product.featuredImage && (
                      <img src={product.featuredImage.url} alt={product.title} className="product-image" />
                    )}
                    <h3>{product.title}</h3>
                    <p style={{color: '#6d7175', fontSize: '13px'}}>{product.status}</p>
                  </div>
                ))}
              </div>
            </>
          ) : (
            <>
              <div className="flex-between" style={{marginBottom: '20px'}}>
                <div>
                  <h2>{selectedProduct.title}</h2>
                  <p style={{color: '#6d7175'}}>Configure unlimited options and variants</p>
                </div>
                <button className="btn btn-secondary" onClick={() => { setSelectedProduct(null); setOptions([]); setCombinations([]); }}>
                  ← Back to Products
                </button>
              </div>

              <div className="tabs">
                <button className={`tab ${activeTab === 'options' ? 'active' : ''}`} onClick={() => setActiveTab('options')}>
                  Options ({options.length})
                </button>
                <button className={`tab ${activeTab === 'variants' ? 'active' : ''}`} onClick={() => setActiveTab('variants')}>
                  Variants ({combinations.length})
                </button>
              </div>

              {activeTab === 'options' && (
                <>
                  <h3>Create Options</h3>
                  <div className="input-group">
                    <label>Option Name (e.g., Size, Color, Material)</label>
                    <div className="flex">
                      <input
                        type="text"
                        value={newOption.name}
                        onChange={(e) => setNewOption({ ...newOption, name: e.target.value })}
                        placeholder="Enter option name"
                      />
                      <button className="btn btn-primary" onClick={addOption}>Add Option</button>
                    </div>
                  </div>

                  {options.map(option => (
                    <div key={option.option_name} className="option-item">
                      <div className="flex-between">
                        <h3>{option.option_name}</h3>
                        <button className="btn btn-danger" onClick={() => removeOption(option.option_name)}>Remove</button>
                      </div>

                      <div className="input-group">
                        <label>Add Values</label>
                        <div className="flex">
                          <input
                            type="text"
                            value={newOption.value}
                            onChange={(e) => setNewOption({ ...newOption, value: e.target.value })}
                            placeholder="Enter value"
                          />
                          <button className="btn btn-primary" onClick={() => addValueToOption(option.option_name)}>Add</button>
                        </div>
                      </div>

                      <div className="option-values">
                        {option.values.map(value => (
                          <div key={value} className="value-tag">
                            {value}
                            <button onClick={() => removeValue(option.option_name, value)}>×</button>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}

                  {options.length > 0 && (
                    <div className="flex" style={{marginTop: '20px'}}>
                      <button className="btn btn-primary" onClick={saveOptions}>Save Options</button>
                      <button className="btn btn-secondary" onClick={generateCombinations}>Generate Combinations →</button>
                    </div>
                  )}
                </>
              )}

              {activeTab === 'variants' && combinations.length > 0 && (
                <>
                  <h3>Configure Pricing & Inventory ({combinations.length} variants)</h3>
                  <table className="variant-table">
                    <thead>
                      <tr>
                        <th>Options</th>
                        <th>Price</th>
                        <th>SKU</th>
                        <th>Inventory</th>
                        <th>Active</th>
                      </tr>
                    </thead>
                    <tbody>
                      {combinations.map((variant, index) => (
                        <tr key={index}>
                          <td>
                            {variant.options.map(opt => `${opt.name}: ${opt.value}`).join(' / ')}
                          </td>
                          <td>
                            <input
                              type="number"
                              step="0.01"
                              value={variant.price}
                              onChange={(e) => updateVariantField(index, 'price', e.target.value)}
                              placeholder="0.00"
                            />
                          </td>
                          <td>
                            <input
                              type="text"
                              value={variant.sku}
                              onChange={(e) => updateVariantField(index, 'sku', e.target.value)}
                              placeholder="SKU"
                            />
                          </td>
                          <td>
                            <input
                              type="number"
                              value={variant.inventory_qty}
                              onChange={(e) => updateVariantField(index, 'inventory_qty', parseInt(e.target.value))}
                              placeholder="0"
                            />
                          </td>
                          <td>
                            <input
                              type="checkbox"
                              checked={variant.is_active}
                              onChange={(e) => updateVariantField(index, 'is_active', e.target.checked)}
                            />
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  <button className="btn btn-primary" onClick={saveVariants}>Save All Variants</button>
                </>
              )}
            </>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));

    // Initialize Shopify App Bridge
    const apiKey = '%VITE_SHOPIFY_API_KEY%';
    const host = new URLSearchParams(window.location.search).get('host');

    if (apiKey && host && window.ShopifyApp) {
      const app = window.ShopifyApp.createApp({
        apiKey: apiKey,
        host: host,
      });
    }
  </script>
</body>
</html>
